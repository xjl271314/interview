---
title: HTTPS
nav:
  title: http
  path: /http
group:
  title: http相关
  path: /http/project/base
---

# https

- 2022.03.22

## 定义

`超文本传输安全协议（Hypertext Transfer Protocol Secure`，缩写：`HTTPS`，常称为`HTTP over TLS`，`HTTP over SSL` 或 `HTTP Secure` ）是一种通过计算机网络进行安全通信的传输协议。

`HTTPS`经由`HTTP`进行通信，但利用`SSL(Secure Socket Layer 安全套接层)/TLS(Transport Layer Security 安全层传输协议)`来加密数据包。

![HTTPS](https://img-blog.csdnimg.cn/2020020813541846.png?x-oss-process=image,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3hqbDI3MTMxNA==,size_16,color_FFFFFF,t_70)

## 作用

HTTPS 主要作用是：

1. 对数据进行加密，并建立一个信息安全通道，来保证传输过程中的数据安全。
2. 对网站服务器进行真实身份认证。

**简单的总结就是: HTTPS = HTTP+加密+认证+完整性保护。**

网站中出现的各种广告也是由于 HTTP 在传输时被劫持而导致的，这种劫持再简单不过，只需要设定相应的 DNS，做一个中间人攻击，再将修改后的数据返回。

## HTTPS 的加密方式

https = 非对称加密 + 数字摘要 + 数字签名 + 对称加密

## TLS/SSL 工作原理

HTTPS 协议的主要功能基本都依赖于`TLS/SSL协议`，`TLS/SSL`的功能实现主要依赖于三类基本算法：`散列函数 Hash`、`对称加密`和`非对称加密`。

**利用非对称加密实现身份认证和密钥协商，对称加密算法采用协商的密钥对数据加密，基于散列函数验证信息的完整性。**

![TSL/SSL](https://img-blog.csdnimg.cn/20200208140622882.png?x-oss-process=image,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3hqbDI3MTMxNA==,size_16,color_FFFFFF,t_70)

### 交互的流程

![TSL/SSL交互流程](https://img-blog.csdnimg.cn/20200208140631461.png?x-oss-process=image,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3hqbDI3MTMxNA==,size_16,color_FFFFFF,t_70)

### 散列函数 Hash

常见的有 `MD5`、`SHA1`、`SHA256`，该类函数特点是**函数单向不可逆、对输入非常敏感、输出长度固定**，针对数据的任何修改都会改变散列函数的结果，用于防止信息篡改并验证数据的完整性;

在信息传输过程中，散列函数不能单独实现信息防篡改，因为明文传输，中间人可以修改信息之后重新计算信息摘要，因此需要对传输的信息以及信息摘要进行加密;

### 对称加密

常见的有`AES-CBC`、`DES`、`3DES`、`AES-GCM`等，相同的密钥可以用于信息的加密和解密，掌握密钥才能获取信息，能够防止信息窃听，通信方式是 1 对 1;

对称加密的优势是信息传输 1 对 1，需要共享相同的密码，密码的安全是保证信息安全的基础，服务器和 N 个客户端通信，需要维持 N 个密码记录，且缺少修改密码的机制;

### 非对称加密

即常见的 `RSA` 算法，还包括 `ECC`、`DH` 等算法，算法特点是，密钥成对出现，一般称为公钥(公开)和私钥(保密)，公钥加密的信息只能私钥解开，私钥加密的信息只能公钥解开。因此掌握公钥的不同客户端之间不能互相解密信息，只能和掌握私钥的服务器进行加密通信，服务器可以实现 1 对多的通信，客户端也可以用来验证掌握私钥的服务器身份。

`非对称加密`的特点是**信息传输 1 对多**，服务器只需要维持一个私钥就能够和多个客户端进行加密通信，但服务器发出的信息能够被所有的客户端解密，且该算法的计算复杂，加密速度慢。

### 总结

```jsx
/**
 * inline: true
 */
import React from 'react';
import { Info } from 'interview';

const txt =
  '\n客户端使用`非对称加密与服务器进行通信`，实现身份验证(CA证书)并`协商对称加密使用的密钥`，然后`对称加密算法`使用用`协商后的密钥`对信息以及信息摘要进行加密通信，不同的节点之间采用的对称密钥不同，从而可以保证信息只能通信双方获取。';

export default () => (
  <Info title="结合三类算法的特点，TLS的基本工作方式是:" txt={txt} />
);
```

## PKI 体系

### RSA 身份验证的隐患

`身份验证`和`密钥协商`是 TLS 的基础功能，要求的前提是合法的服务器掌握着对应的私钥。但 `RSA` 算法无法确保服务器身份的合法性，因为公钥并不包含服务器的信息，存在安全隐患:

- 客户端 C 和服务器 S 进行通信，中间节点 M 截获了二者的通信;
- 节点 M 自己计算产生一对公钥 pub_M 和私钥 pri_M;
- C 向 S 请求公钥时，M 把自己的公钥 pub_M 发给了 C;
- C 使用公钥 pub_M 加密的数据能够被 M 解密，因为 M 掌握对应的私钥 pri_M，而 C 无法根据公钥信息判断服务器的身份，从而 C 和 \* M 之间建立了"可信"加密连接;
- 中间节点 M 和服务器 S 之间再建立合法的连接，因此 C 和 S 之间通信被 M 完全掌握，M 可以进行信息的窃听、篡改等操作。
- 另外，服务器也可以对自己的发出的信息进行否认，不承认相关信息是自己发出。

因此该方案下至少存在两类问题：`中间人攻击`和`信息抵赖`。

![RSA 身份验证的隐患](https://img-blog.csdnimg.cn/2020020814180822.png?x-oss-process=image,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3hqbDI3MTMxNA==,size_16,color_FFFFFF,t_70)

### 身份验证 CA 和证书

解决上述身份验证问题的关键是确保获取的公钥途径是合法的，能够验证服务器的身份信息，为此需要引入权威的第三方机构 CA(如沃通 CA)。

CA 负责核实公钥的拥有者的信息，并颁发认证"证书"，同时能够为使用者提供证书验证服务，即 PKI 体系(PKI 基础知识)。

**基本的原理为，CA 负责审核信息，然后对关键信息利用私钥进行"签名"，公开对应的公钥，客户端可以利用公钥验证签名。CA 也可以吊销已经签发的证书，基本的方式包括两类 CRL 文件和 OCSP。**

CA 使用具体的流程如下：

![CA 使用流程](https://img-blog.csdnimg.cn/20200208142030173.png?x-oss-process=image,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3hqbDI3MTMxNA==,size_16,color_FFFFFF,t_70)

1. 服务方 S 向第三方机构 CA 提交公钥、组织信息、个人信息(域名)等信息并申请认证;

2. CA 通过线上、线下等多种手段验证申请者提供信息的真实性，如组织是否存在、企业是否合法，是否拥有域名的所有权等;

3. 如信息审核通过，CA 会向申请者签发认证文件-证书。

   证书包含以下信息：`申请者公钥`、`申请者的组织信息和个人信息`、`签发机构CA的信息`、`有效时间`、`证书序列号`等信息的明文，同时包含一个签名;

   签名的产生算法：首先，使用散列函数计算公开的明文信息的信息摘要，然后，采用 CA 的私钥对信息摘要进行加密，密文即签名;

4. 客户端 C 向服务器 S 发出请求时，S 返回证书文件;

5. 客户端 C 读取证书中的相关的明文信息，采用相同的散列函数计算得到信息摘要，然后，利用对应 CA 的公钥解密签名数据，对比证书的信息摘要，如果一致，则可以确认证书的合法性，即公钥合法;

6. 客户端然后验证证书相关的域名信息、有效时间等信息;

7. 客户端会内置信任 CA 的证书信息(包含公钥)，如果 CA 不被信任，则找不到对应 CA 的证书，证书也会被判定非法。

```jsx
/**
 * inline: true
 */
import React from 'react';
import { Info } from 'interview';

const txt =
  '\n1.申请证书不需要提供`私钥`，确保私钥永远只能服务器掌握;\n\n2.证书的合法性仍然依赖于`非对称加密算法`，证书主要是增加了服务器信息以及签名;\n\n3.内置 CA 对应的证书称为根证书，颁发者和使用者相同，自己为自己签名，即自签名证书（为什么说"部署自签 SSL 证书非常不安全"）\n\n4.证书=公钥+申请者与颁发者信息+签名;';

export default () => (
  <Info title="在这个过程注意几点：" type="warning" txt={txt} />
);
```

### 证书链

如 CA 根证书和服务器证书中间增加一级证书机构，即`中间证书`，证书的产生和验证原理不变，只是增加一层验证，只要最后能够被任何信任的 CA 根证书验证合法即可。

1. 服务器证书 `server.pem` 的签发者为中间证书机构 `inter`，`inter` 根据证书 `inter.pem` 验证 `server.pem` 确实为自己签发的有效证书;

2. 中间证书 `inter.pem` 的签发 CA 为 `root`，`root` 根据证书 `root.pem` 验证 `inter.pem` 为自己签发的合法证书;

3. 客户端内置信任 CA 的 `root.pem` 证书，因此服务器证书 `server.pem` 的被信任。

![证书链](https://img-blog.csdnimg.cn/20200208142837116.png?x-oss-process=image,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3hqbDI3MTMxNA==,size_16,color_FFFFFF,t_70)

服务器证书、中间证书与根证书在一起组合成一条合法的证书链，证书链的验证是自下而上的信任传递的过程。

#### 二级证书结构存在的优势

1. 减少根证书结构的管理工作量，可以更高效的进行证书的审核与签发;

2. 根证书一般内置在客户端中，私钥一般离线存储，一旦私钥泄露，则吊销过程非常困难，无法及时补救;

3. 中间证书结构的私钥泄露，则可以快速在线吊销，并重新为用户签发新的证书;

4. 证书链四级以内一般不会对 `HTTPS` 的性能造成明显影响。

![二级证书](https://img-blog.csdnimg.cn/20200208143242796.png?x-oss-process=image,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3hqbDI3MTMxNA==,size_16,color_FFFFFF,t_70)

#### 证书链有以下特点

1. 同一本服务器证书可能存在多条合法的证书链。

   因为证书的生成和验证基础是公钥和私钥对，如果采用相同的公钥和私钥生成不同的中间证书，针对被签发者而言，该签发机构都是合法的 CA，不同的是中间证书的签发机构不同;

2. 不同证书链的层级不一定相同，可能二级、三级或四级证书链。

   中间证书的签发机构可能是根证书机构也可能是另一个中间证书机构，所以证书链层级不一定相同。

### 证书吊销

CA 机构能够签发证书，同样也存在机制宣布以往签发的证书无效。证书使用者不合法，CA 需要废弃该证书;或者私钥丢失，使用者申请让证书无效。主要存在两类机制：`CRL` 与 `OCSP`。

- #### CRL(Certificate Revocation List)证书吊销列表

  一个单独的文件。该文件包含了 CA 已经吊销的证书序列号(唯一)与吊销日期，同时该文件包含生效日期并通知下次更新该文件的时间，当然该文件必然包含 CA 私钥的签名以验证文件的合法性。

  证书中一般会包含一个 URL 地址 `CRL Distribution Point`，通知使用者去哪里下载对应的 CRL 以校验证书是否吊销。

  该吊销方式的优点是不需要频繁更新，但是不能及时吊销证书，因为 CRL 更新时间一般是几天，这期间可能已经造成了极大损失。

- #### OCSP(Online Certificate Status Protocol)证书状态在线查询协议

  一个实时查询证书是否吊销的方式。请求者发送证书的信息并请求查询，服务器返回正常、吊销或未知中的任何一个状态。证书中一般也会包含一个 OCSP 的 URL 地址，要求查询服务器具有良好的性能。

  部分 CA 或大部分的自签 CA (根证书)都是未提供 CRL 或 OCSP 地址的，对于吊销证书会是一件非常麻烦的事情。

## HTTPS 性能与优化

### HTTPS 性能损耗

前文讨论了`HTTPS原理与优势`：身份验证、信息加密与完整性校验等，且未对 `TCP` 和 `HTTP` 协议做任何修改。但通过增加新协议以实现更安全的通信必然需要付出代价，HTTPS 协议的性能损耗主要体现如下：

1. 增加延时

   分析前面的握手过程，一次完整的握手至少需要两端依次来回两次通信，至少增加延时`2* RTT`，利用会话缓存从而复用连接，延时也至少`1* RTT*`。

2. 消耗较多的 CPU 资源

   除数据传输之外，HTTPS 通信主要包括对对称加解密、非对称加解密(服务器主要采用私钥解密数据);

   压测 TS8 机型的单核 CPU：对称加密算法 AES-CBC-256 吞吐量 600Mbps，非对称 RSA 私钥解密 200 次/s。

   不考虑其它软件层面的开销，10G 网卡为对称加密需要消耗 CPU 约 17 核，24 核 CPU 最多接入 HTTPS 连接 4800;

   静态节点当前 10G 网卡的 TS8 机型的 HTTP 单机接入能力约为 10w/s，如果将所有的 HTTP 连接变为 HTTPS 连接，则明显 RSA 的解密最先成为瓶颈。因此，RSA 的解密能力是当前困扰 HTTPS 接入的主要难题。

### HTTPS 接入优化

1. CDN 接入

   HTTPS 增加的延时主要是`传输延时 RTT`，RTT 的特点是节点越近延时越小，CDN 天然离用户最近，因此选择使用 CDN 作为 HTTPS 接入的入口，将能够极大减少接入延时。CDN 节点通过和业务服务器维持长连接、会话复用和链路质量优化等可控方法，极大减少 HTTPS 带来的延时。

2. 会话缓存

   虽然前文提到 HTTPS 即使采用会话缓存也要至少`1*RTT`的延时，但是至少延时已经减少为原来的一半，明显的延时优化;

   同时，基于会话缓存建立的 HTTPS 连接不需要服务器使用 RSA 私钥解密获取 Pre-master 信息，可以省去 CPU 的消耗。

   如果业务访问连接集中，缓存命中率高，则 HTTPS 的接入能力将明显提升。当前 TRP 平台的缓存命中率高峰时期大于 30%，10k/s 的接入资源实际可以承载 13k/的接入，收效非常可观。

3. 硬件加速

   为接入服务器安装专用的 SSL 硬件加速卡，作用类似 GPU，释放 CPU，能够具有更高的 HTTPS 接入能力且不影响业务程序的。

   测试某硬件加速卡单卡可以提供 35k 的解密能力，相当于 175 核 CPU，至少相当于 7 台 24 核的服务器，考虑到接入服务器其它程序的开销，一张硬件卡可以实现接近 10 台服务器的接入能力。

4. 远程解密

   本地接入消耗过多的 CPU 资源，浪费了网卡和硬盘等资源，考虑将最消耗 CPU 资源的 RSA 解密计算任务转移到其它服务器，如此则可以充分发挥服务器的接入能力，充分利用带宽与网卡资源。

   远程解密服务器可以选择 CPU 负载较低的机器充当，实现机器资源复用，也可以是专门优化的高计算性能的服务器。当前也是 CDN 用于大规模 HTTPS 接入的解决方案之一。

5. HTTP2

   前面的方法分别从减少传输延时和单机负载的方法提高 HTTPS 接入性能，但是方法都基于不改变 HTTP 协议的基础上提出的优化方法，HTTP2 利用 TLS/SSL 带来的优势，通过修改协议的方法来提升 HTTPS 的性能，提高下载速度等。

6. 使用 DNS
