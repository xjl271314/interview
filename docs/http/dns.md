---
title: 域名系统DNS
nav:
  title: http
  path: /http
group:
  title: http相关
  path: /http/project/base
---

# 域名系统 DNS

- 2022.01.04

## DNS 定义

DNS 叫做`域名系统`，是`域名`和`对应ip地址`的`分布式数据库`。

## DNS 解析过程

DNS 解析过程是将`域名`解析成 `IP 地址`的过程。

### 1. 查找浏览器缓存

在浏览器中输入后 url 后，浏览器会检查缓存中有没有这个域名对应的解析过的 IP 地址，如果缓存中有，这个解析过程就将结束。

**浏览器缓存域名也是有限制的，不仅浏览器缓存大小有限制，而且缓存的时间也有限制，通常情况下为几分钟到几小时不等(通过 TTL 属性来设置，默认情况下 Chrome 会缓存 1 分钟的 DNS 查找。)。**

这个缓存时间太长和太短都不好，如果缓存时间太长，一旦域名被解析到的 IP 有变化，会导致被客户端缓存的域名无法解析到变化后的 IP 地址，以致该域名不能正常解析，这段时间内有可能会有一部分用户无法访问网站。如果时间设置太短，会导致用户每次访问网站都要重新解析一次域名。

**实际情况下尽管操作系统缓存会考虑 TTL 值，但浏览器通常忽略该值，并设置它自己的时间限制。**

[浏览器查看和清除 DNS 缓存](https://www.cnblogs.com/shengulong/p/7443806.html)

#### 如何清除系统的 DNS 缓存?

- window:

  ```js
  // 查看
  ipconfig / displaydns;

  // 清除
  ipconfig / flushdns;
  ```

- macOS:

  ```js
  sudo killall -HUP mDNSResponder
  ```

### 2. 查找系统缓存(hosts 缓存)

如果用户的`浏览器缓存`中没有，浏览器会查找`操作系统缓存`中是否有这个域名对应的 DNS 解析结果。

操作系统也会有一个域名解析的过程，例如在`Windows`中可以通过`C:\Windows\System32\drivers\etc\hosts`文件来设置。我们可以将任何域名解析到任何能够访问的 IP 地址。

假如我们在这里指定了一个域名对应的 IP 地址，那么浏览器会首先使用这个 IP 地址。

- 例如，我们在测试时可以将一个域名解析到一台测试服务器上，这样不用修改任何代码就能测试到单独服务器上的代码的业务逻辑是否正确。

  也正是因为有这种本地 DNS 解析的规程，所以黑客就有可能通过修改你的域名解析来把特定的域名解析到它指定的 IP 地址上，导致这些域名被劫持。

  - [macOS 修改 hosts 文件](https://jingyan.baidu.com/article/f3ad7d0f55154309c3345bdd.html)
  - [windows 修改 hosts 文件](https://jingyan.baidu.com/article/9113f81b49ed2f2b3214c7fa.html)

### 3. 查找路由器缓存

如果系统缓存中也找不到，那么查询请求就会发向路由器，它一般会有自己的 DNS 缓存。

### 4. 查找 ISP DNS 缓存

如果本地 hosts 文件不存在映射关系，则查找本地 DNS 服务器(ISP 服务器,或者自己手动设置的 DNS 服务器)。

在我们的网络配置中都会有"DNS 服务器地址"这一项，操作系统会把这个域名发送给这里设置的 DNS，也就是本地区的域名服务器（LDNS），通常由互联网服务提供商（ISP）提供，比如电信或者联通。

这个专门的域名解析服务器性能都会很好，它们一般都会缓存域名解析结果，当然缓存时间是受域名的失效时间控制的，一般缓存空间不是影响域名失效的主要因素。大约 80%的域名解析都到这里就已经完成了，所以 ISP DNS 主要承担了域名的解析工作。

### 5. DNS Lookup 迭代查询

如果`本地 DNS 服务器`还没找到的话，这个时间就进入了`DNS Lookup`环节。

首先`本地DNS服务器`会向`根服务器`(实际上`www.baidu.com` 的完整写法是 `www.baidu.com.`，最后的这个 `.` 就是`根域名`，只是这个点我们一般都不写)发出请求，进行递归查询。

`根域名服务器`将所要查询域名中的`顶级域名`（假设要查询`www.baidu.com`，该域名的顶级域就是`com`）的服务器 IP 地址返回到`本地 DNS`。

`本地 DNS` 根据返回的 IP 地址，再向`顶级域`（就是 com 域）发送请求，如果有记录，就返回查询结果。

如果没有记录的话，`com域服务器`再将域名中的`二级域`（即`www.baidu.com`中的`baidu`）的 IP 地址返回给`本地 DNS`。

本地 DNS 再向`二级域`发送请求进行查询。

之后不断重复这样的过程，直到`本地 DNS 服务器`得到最终的查询结果，并返回到主机。这时候主机才能通过域名访问该网站。

## DNS 性能优化

### 1. DNS 缓存优化

- 使用浏览器 DNS 缓存 、计算机 DNS 缓存、 服务器 DNS 缓存，防止 DNS 迭代查询；
- HTTP 协议中的 `Keep-Alive` 特性可以同时覆盖 `TTL` 和浏览器的时间限制。通过设置 `Keep-Alive`，一个持久的 TCP 连接将会一直使用，直到其空闲 1 分钟为止，由于连接是持久的，`Keep-Alive`通过重用现有的连接，避免了 DNS 查找；
- 使用较少的域名（服务器主机）来减少 DNS 查找的数量。

### 2. DNS 预加载策略(DNS Prefetch)

`DNS Prefetch` 是一种`DNS 预解析技术`，当你浏览网页时，浏览器会在对网页中的域名进行解析缓存，这样当页面中需要加载该域名的资源时就无需解析，减少用户等待时间，提高用户体验。

- 通过用`meta`信息来告知浏览器, 我这页面要做 DNS 预解析

  ```html
  <meta http-equiv="x-dns-prefetch-control" content="on" />
  ```

- 通过设置响应头的方式

  ```js
  ctx.set('X-DNS-Prefetch-Control', 'on');
  ```

- 通过使用`link标签`来强制对 DNS 做预解析:

  ```html
  <link rel="dns-prefetch" href="https://fonts.com" />
  ```

  - `dns-prefetch`仅对`跨域`的 DNS 查找有效。
  - `dns-prefetch`要谨慎使用，多页面重复 DNS 预解析会增加 DNS 查询次数。
  - 默认情况下浏览器会对页面中和当前域名不在同一个域的域名进行预获取，并且缓存结果，这就是隐式的 `dns-prefetch`。如果想对页面中没有出现的域进行获取，那么就要使用显示的`dns-prefetch`了。
