---
title: keep alive
nav:
  title: http
  path: /http
group:
  title: http
  path: /http/project
---

# HTTP keep-alive 和 TCP keepalive 的区别

- 2022.01.11

## TCP 协议简介

TCP 协议也叫`传输控制协议（TCP，Transmission Control Protocol）`是一种面向连接的、可靠的、基于字节流的传输层通信协议。使用 TCP 的两个程序（客户端和服务端）在交换数据前，通过三次握手来建立 TCP 连接，建立连接后就可以进行基于字节流的双工通讯，由 TCP 内部实现保证通讯的可靠性，完全通讯完成后，通过四次挥手断开连接。

在客户端和服务端间的网络一切正常、且双方都没主动发起关闭连接的请求时，此 TCP 连接理论上可以永久保持。**但是，网络情况是及其复杂的，在双方长时间未通讯时，如何得知对方还活着？如何得知这个 TCP 连接是健康且具有通讯能力的？**

## TCP keepalive

针对上述的问题，就需要采用**TCP 的保活机制**来解决问题。

**保活机制**默认是关闭的，TCP 连接的任何一方都可打开此功能。有三个主要配置参数用来控制保活功能。

如果在保活时间内此连接都不活跃，开启保活功能的一端会向对端发送一个保活探测报文。

- 若对端正常存活，且连接有效，对端必然能收到探测报文并进行响应。此时，发送端收到响应报文则证明 TCP 连接正常，重置保活时间计数器即可。

- 若由于网络原因或其他原因导致，发送端无法正常收到保活探测报文的响应。那么在一定探测时间间隔（tcp_keepalive_intvl）后，将继续发送保活探测报文。直到收到对端的响应，或者达到配置的探测循环次数上限（tcp_keepalive_probes）都没有收到对端响应，这时对端会被认为不可达，TCP 连接存在但已失效，需要将连接做中断处理。

在探测过程中，对端主机会处于以下四种状态之一：

|                        状态                        | 处理                                                                             |
| :------------------------------------------------: | -------------------------------------------------------------------------------- |
|              对方主机仍在工作并且可达              | TCP 连接正常，并将保活计时器重置                                                 |
|           对方主机已崩溃(关闭、正在重启)           | TCP 连接不正常，经过指定次数的探测依然没有得到响应的话就断开连接                 |
|              对方主机崩溃并且已经重启              | 重启后原连接已经失效，对方由于不认识探测报文，会响应重置报文段，请求端将连接断开 |
| 对方主机仍在工作，但由于某些原因不可达(如网络原因) | TCP 连接不正常，经过指定次数的探测依然没有得到响应的话就断开连接                 |

### 名词解释

- 保活时间：tcp_keepalive_time
- 探测时间间隔：tcp_keepalive_intvl
- 探测循环次数：tcp_keepalive_probes

#### 针对 linux 系统，TCP 保活超时时间、探测报文段发送间隔、探测报文段最大发送次数都是可以设置的，如下

```linux
# cat /proc/sys/net/ipv4/tcp_keepalive_time  7200 当keepalive启用的时候，TCP发送keepalive消息的频度。缺省是2小时

# cat /proc/sys/net/ipv4/tcp_keepalive_intvl  75  当探测没有确认时，重新发送探测的频度。缺省是75秒

# cat /proc/sys/net/ipv4/tcp_keepalive_probes  9  探测尝试的次数。如果第1次探测包就收到响应了，则后8次的不再发
```

#### Linux 平台下我们还可以借助 man 命令查看 TCP 协议的一些描述和参数定义。下面两个命令的效果相同

- 命令一：man tcp
- 命令二：man 7 tcp

## HTTP keep-alive

http 协议是一个运行在 TCP 协议之上的无状态的应用层协议。它的特点是：客户端的每一次请求都要和服务端创建 TCP 连接，服务器响应后，断开 TCP 连接。下次客户端再有请求，则重新建立连接。

在早期的`http1.0`中，默认就是上述介绍的这种“请求-应答”模式。这种方式频繁的创建连接和销毁连接无疑是有一定性能损耗的。

所以引入了`keep-alive`机制。http1.0 默认是关闭的，通过 http 请求头设置`connection: keep-alive`进行开启；`http1.1`中默认开启，通过 http 请求头设置`connection: close`关闭。

`keep-alive`机制：若开启后，在一次 http 请求中，服务器进行响应后，不再直接断开 TCP 连接，而是将 TCP 连接维持一段时间。在这段时间内，如果同一客户端再次向服务端发起 http 请求，便可以复用此 TCP 连接，向服务端发起请求，并重置 timeout 时间计数器，在接下来一段时间内还可以继续复用。这样无疑省略了反复创建和销毁 TCP 连接的损耗。
