---
title: 性能优化
nav:
  title: 前端框架
  path: /frontend
  order: 0
group:
  title: 微信小程序
  path: /miniprogram/project
---

# 小程序中如何进行性能优化？

- 2021.06.22

## 如何查找可优化的点?

在微信小程序开发者工具中提供了性能分析工具(性能 Trace 工具)，我们可以很方便的通过跑分建议来进行相应的优化。

其中提供了以下几个信息:

![性能面板](https://res.wx.qq.com/wxdoc/dist/assets/img/panel.13423a08.jpg)

| 指标           | 描述                                                  |
| :------------- | :---------------------------------------------------- |
| `CPU`          | 小程序进程的 CPU 占用率，仅 Android 下提供            |
| `内存`         | 小程序进程的内存占用（Total Pss)，仅 Android 下提供   |
| `启动耗时`     | 小程序启动总耗时                                      |
| `下载耗时`     | 小程序包下载耗时，首次打开或资源包需更新时会进行下载  |
| `页面切换耗时` | 小程序页面切换的耗时                                  |
| `帧率/FPS`     | -                                                     |
| `首次渲染耗时` | 页面首次渲染的耗时                                    |
| `再次渲染耗时` | 页面再次渲染的耗时（通常由开发者的 setData 操作触发） |
| `数据缓存`     | 小程序通过 Storage 接口储存的缓存大小                 |

因此根据上述的指标我们可以通过下面的方案进行优化:

## 启动加载优化

在小程序启动时，微信会在背后完成几项工作：`下载小程序代码包`、`加载小程序代码包`、`初始化小程序首页`。

初始化小程序环境是微信环境做的工作,我们只需要控制代码包大小，和通过一些相关的`缓存策略控制`，和`资源控制`，`逻辑控制`，`分包加载`控制来进行启动加载优化。

- 勾选开发者工具中， 上传时压缩代码（若采用 wepy 高级版本，自带压缩，请按官网文档采取点击）。

- 精简代码，去掉不必要的 WXML 结构和未使用的 WXSS 定义。

- 减少在代码包中直接嵌入的资源文件。（比如全国地区库，微信有自带的，在没必要的时候，勿自用自己的库）。

- 及时清理无用的资源（js 文件、图片、demo 页面等）。

- 压缩图片，使用适当的图片格式，减少本地图片数量等。

- 如果小程序比较复杂，优化后的代码总量可能仍然比较大，此时可以采用分包加载的方式进行优化，分包加载初始化时只加载首屏相关、高频访问的资源，其他的按需加载。分包的子包还可以通过预加载的方式进行加载，将用户在当先页可能点击的子包页面先加载，当用户点击后直接跳转。

- 提前做异步请求，页面最好在`onLoad`时异步请求数据，不要在`onReady`时请求。

- 启用缓存数据策略，请求时先展示缓存内容，让页面尽快展示，请求到最新数据之后再刷新。

- 避免白屏，使用骨架屏等。

## 数据通信优化

为了提升数据更新的性能，开发者在执行 setData 调用时，最好遵循以下原则：

- 不要过于频繁调用 setData，应考虑将多次 setData 合并成一次 setData 调用；

- 数据通信的性能与数据量正相关，因而如果有一些数据字段不在界面中展示且数据结构比较复杂或包含长字符串，则不应使用 setData 来设置这些数据；

- 与界面渲染无关的数据最好不要设置在 data 中，可以考虑设置在 page 对象的其他字段下。

提升数据更新性能方式的代码示例：

```js
Page({
  onShow: function () {
    // 不要频繁调用setData
    this.setData({ a: 1 });
    this.setData({ b: 2 });
    // 绝大多数时候可优化为
    this.setData({ a: 1, b: 2 });

    // 不要设置不在界面渲染时使用的数据，并将界面无关的数据放在data外
    this.setData({
      myData: {
        a: '这个字符串在WXML中用到了',
        b: '这个字符串未在WXML中用到，而且它很长…………………………',
      },
    });
    // 可以优化为
    this.setData({
      'myData.a': '这个字符串在WXML中用到了',
    });
    this._myData = {
      b: '这个字符串未在WXML中用到，而且它很长…………………………',
    };
  },
});
```

## 事件通信优化

视图层会接受用户事件，如`点击事件`、`触摸事件`等。当一个用户事件被触发且有相关的事件监听器需要被触发时，视图层会将信息反馈给逻辑层。这个反馈是异步的，会产生延迟，降低延迟的方法有两个：

- 去掉不必要的事件绑定（WXML 中的 bind 和 catch），从而减少通信的数据量和次数；

- 事件绑定时需要传输 `target` 和 `currentTarget` 的 `dataset`，因而不要在节点的 `data` 前缀属性中放置过大的数据。

另外针对某些操作我们还可以进行防抖和节流，减少不必要的通信消耗。

## 渲染优化

- 页面方法 `onPageScroll` 使用， 每次页面滚动都会触发，避免在里面写过于复杂的逻辑 ，特别是一些执行重渲染页面的逻辑。

- 在进行视图重渲染的时候，会进行当前节点树与新节点树的比较，去掉不必要设置的数据、减少 `setData` 的数据量也有助于提升这一个步骤的性能。

- 针对图片类展示组件使用懒加载的方式，减少不必要的 http 请求。

- 针对图标类进行图片的压缩，部分可以采用 `iconfont` 的方式的图标进行展示减少图片加载。
