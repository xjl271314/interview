---
title: 服务端渲染
nav:
  title: Vue
  path: /vue
  order: 0
group:
  title: vue2
  path: /vue/2.0
---

# 服务端渲染

- 2022.11.02

vue 项目，可以使用[Nest.js 框架](https://nestjs.bootcss.com/)，实现 ssr 渲染，开发有 SEO 需求的页面。

## SSR 原理

通过 `asyncData` 获取数据，数据获取成功后，通过 `vue-server-renderer` 将数据渲染到页面中，生成完整的`html` 内容，服务端将这段 `html` 发送给客户端，实现服务端渲染。

## SSR 基本交互流程

1. **在浏览器访问首页时，Web 服务器根据路由拿到对应数据渲染并输出 html，输出的 html 包含两部分：**

   1. 路由页对应的页面及已渲染好的数据（后端渲染）
   2. 完整的 SPA 程序代码

2. **在客户端首屏渲染完成之后，其实已经是一个和之前的 SPA 相差无几的应用程序了，接下来我们进行的任何操作都只是客户端的应用进行交互。**

## vue SSR 整体流程

1. 配置两个入口文件，一个是客户端使用，一个是服务端使用，一套代码两套执行环境。

2. 服务端渲染需要 Vue 实例，每一次客户端请求页面，服务端渲染都是用一个新的 Vue 实例，服务端利用工厂函数每次都返回一个新的 Vue 实例。

3. 获取请求页面的路由，生成对应的 vue 实例。

4. 如果页面中需要调接口获取数据，通过 `asyncData` 获取数据，数据获取成功后，通过异步的方式再继续进行初始化，通过 `vue-server-renderer` 将数据渲染到页面中，生成 html 内容。

**如何避免客户端重复请求数据？**

在服务端已经请求的数据，在客户端应该避免重复请求，怎样同步数据到客户端？

**通过（window 对象作为中间媒介进行传递数据）**

1. 服务端获取数据，保存到服务端的 `store` 状态，以便渲染时候使用，最终会将 `store` 保存到 `window` 中。

2. 在 `renderer` 中会在 `html` 代码中添加 `<script>window.__INITIAL_STATE__ = context.state</script>`，在解析页面的时候会进行设置全局变量。

3. 在浏览器进行初始化 `Store` 的时候，通过 `window` 对象进行获取数据在服务端的状态，并且将其注入到 `store.state` 状态中，这样能够实现状态统一。

**为什么服务端渲染不能调用 mounted 钩子？**

服务端渲染不能调用 `beforeMount` 和 `mounted`，`Node`环境没有 `document`对象，初始化的时候，`vue`底层会判断当前环境中是否有`el`这个`dom`对象，如果没有，就不会执行到 `beforeMount` 和 `mounted` 这两个钩子函数。
